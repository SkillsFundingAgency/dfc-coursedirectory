{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "projectPrefix": {
      "type": "string",
      "metadata": {
        "description": "Prefix for all resources created for the project (except storage account, see below). Should be in the format dfc-env-proj"
      }
    },
    "projectSuffix": {
      "type": "string",
      "metadata": {
        "description": "Suffix for all resources created for the project (except storage account, see below). Should be in the format dfc-env-proj"
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of the project storage account (as it follows a different naming convention)"
      }
    },
    "postcodeApiUrl": {
      "type": "string",
      "metadata": {
        "description": "API URL for the postcode search"
      }
    },
    "getAddressApiUrl": {
      "type": "string",
      "metadata": {
        "description": "API URL for the GetAddress postcode search"
      }
    },
    "larsApiUrl": {
      "type": "string",
      "metadata": {
        "description": "API URL for the provider search"
      }
    },
    "courseApiUrl": {
      "type": "string",
      "metadata": {
        "description": "API URL for the course services"
      }
    },
    "apprenticeshipApiUrl": {
      "type": "string",
      "metadata": {
        "description": "API URL for the apprentischip services"
      }
    },
    "searchDomain": {
      "type": "string",
      "metadata": {
        "description": "URL for the search services"
      }
    },
    "larsDatasetUrl": {
      "type": "string",
      "metadata": {
        "description": "Url to download current LARs dataset"
      }
    },
    "dfeClientID": {
      "type": "string",
      "metadata": {
        "description": "DfE Signin client ID"
      }
    },
    "dfeEndpointUrl": {
      "type": "string",
      "metadata": {
        "description": "DfE Signin URL"
      }
    },
    "dfeMetadataUrl": {
      "type": "string",
      "metadata": {
        "description": "DfE Signin metadata URL"
      }
    },
    "dfeCallBackPath": {
      "type": "string",
      "metadata": {
        "description": "Path in URL that DfE Signin calls back after authentication"
      }
    },
    "dfeSignedOutPath": {
      "type": "string",
      "metadata": {
        "description": "Path in URL that DfE Signin calls back after sign out"
      }
    },
    "dfeApiUri": {
      "type": "string",
      "metadata": {
        "description": "DfE Siginin Uri"
      }
    },
    "dfeIssuer": {
      "type": "string",
      "metadata": {
        "description": "DfE Signin issuer"
      }
    },
    "findCourseApiUrl": {
      "type": "string",
      "metadata": {
        "description": "API URL for the course API REST services"
      }
    },
    "findCourseApiKey": {
      "type": "securestring",
      "metadata": {
        "description": "API host key for above"
      }
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Key vault containing secrets"
      }
    },
    "blobStorageSettingsContainerName": {
      "type": "string",
      "metadata": {
        "description": "The name of the provider files container, this is hardcoded into the parameters.json file"
      }
    },
    "BlobStorageSettingsInlineProcessingThreshhold": {
      "type": "string",
      "metadata": {
        "description": "The limit of the number of items to process online.  If broached, offline processing of the bulk upload will occurr"
      }
    },
    "EnvironmentName": {
      "type": "string",
      "metadata": {
        "description": "EnvironmentName to be used in the EnvironmentSetting__EnvironmentName config setting.  This may be different to the Azure DevOps environment"
      }
    },
    "BulkUploadSecondsPerRecord": {
      "type": "string",
      "metadata": {
        "description": "The CourseServiceSettings__BulkUploadSecondsPerRecord app setting"
      }
    },
    "FindACourseUrl": {
      "type": "string",
      "metadata": {
        "description": "The URL for FindACourse for specific environment"
      }
    }
  },
  "variables": {
    "appInsightsName": "[concat(variables('appServiceName'),'-ai')]",
    "appServiceName": "[concat(parameters('projectPrefix'),'-as',parameters('projectSuffix'))]",
    "functionAppName": "[concat(parameters('projectPrefix'),'-fa',parameters('projectSuffix'))]",
    "functionAppInsightsName": "[concat(variables('functionAppName'),'-ai')]"
  },
  "resources": [
    {
      "type": "Microsoft.Web/sites/slots/config",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}/{1}/{2}', variables('appServiceName'), 'staging', 'appsettings')]",
      "properties": {
        "APPLICATIONINSIGHTS_CONNECTION_STRING": "[reference(resourceId('microsoft.insights/components', variables('appInsightsName')), '2015-05-01').ConnectionString]",
        "LarsSearchSettings__ApiUrl": "[parameters('larsApiUrl')]",
        "LarsSearchSettings__ApiKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectorySearchQueryPrimaryKey)', parameters('keyVaultName'))]",
        "LarsSearchSettings__ApiVersion": "2017-11-11",
        "LarsSearchSettings__Indexes": "azuresql-index",
        "LarsSearchSettings__ItemsPerPage": 25,
        "LarsSearchSettings__PageParamName": "PageNo",
        "PostCodeSearchSettings__FindAddressesBaseUrl": "https://services.postcodeanywhere.co.uk/PostcodeAnywhere/Interactive/FindByPostcode/v1.00/json3.ws?",
        "PostCodeSearchSettings__RetrieveAddressBaseUrl": "[parameters('postcodeApiUrl')]",
        "PostCodeSearchSettings__Key": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=PostCodeSearchApiKey)', parameters('keyVaultName'))]",
        "GetAddressSettings__ApiUrl": "[parameters('getAddressApiUrl')]",
        "GetAddressSettings__ApiKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=GetAddressApiKey)', parameters('keyVaultName'))]",
        "CourseServiceSettings__ApiUrl": "[parameters('courseApiUrl')]",
        "CourseServiceSettings__ApiKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectoryPttcdApiPrimaryKey)', parameters('keyVaultName'))]",
        "ApprenticeshipServiceSettings__ApiUrl": "[parameters('apprenticeshipApiUrl')]",
        "ApprenticeshipServiceSettings__ApiKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectoryPttcdApiPrimaryKey)', parameters('keyVaultName'))]",
        "AppUISettings__VenueNameComponentSettings__VenueName_Label": "Venue name",
        "AppUISettings__CourseForComponentSettings__TextFieldMaxChars": "2000",
        "AppUISettings__EntryRequirementsComponentSettings__TextFieldMaxChars": "500",
        "AppUISettings__WhatWillLearnComponentSettings__TextFieldMaxChars": "1500",
        "AppUISettings__HowYouWillLearnComponentSettings__TextFieldMaxChars": "500",
        "AppUISettings__WhatYouNeedComponentSettings__TextFieldMaxChars": "500",
        "AppUISettings__HowAssessedComponentSettings__TextFieldMaxChars": "500",
        "AppUISettings__WhereNextComponentSettings__TextFieldMaxChars": "500",
        "DFESignInSettings__ClientID": "[parameters('dfeClientID')]",
        "DFESignInSettings__ClientSecret": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=DfeSignInClientSecret)', parameters('keyVaultName'))]",
        "DFESignInSettings__TokenEndpoint": "[parameters('dfeEndpointUrl')]",
        "DFESignInSettings__MetadataAddress": "[parameters('dfeMetadataUrl')]",
        "DFESignInSettings__CallbackPath": "[parameters('dfeCallBackPath')]",
        "DFESignInSettings__SignedOutCallbackPath": "[parameters('dfeSignedOutPath')]",
        "DFESignInSettings__Issuer": "[parameters('dfeIssuer')]",
        "DFESignInSettings__Audience": "signin.education.gov.uk",
        "DFESignInSettings__APISecret": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=DfeSignInApiSecret)', parameters('keyVaultName'))]",
        "DFESignInSettings__APIUri": "[parameters('dfeApiUri')]",
        "FindACourseServiceSettings__ApiUrl": "[parameters('findCourseApiUrl')]",
        "FindACourseServiceSettings__ApiKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=FindACourseApimPrimaryKey)', parameters('keyVaultName'))]",
        "FindACourseServiceSettings__UserName": "APIUser",
        "FindACourseServiceSettings__Password": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=FindaCourseServicePassword)', parameters('keyVaultName'))]",
        "BlobStorageSettings__AccountName": "[parameters('storageAccountName')]",
        "BlobStorageSettings__AccountKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectoryStorageAccountKey)', parameters('keyVaultName'))]",
        "BlobStorageSettings__Container": "[parameters('blobStorageSettingsContainerName')]",
        "BlobStorageSettings__TemplatePath": "bulkuploadtemplate.csv",
        "BlobStorageSettings__InlineProcessingThreshold": "[parameters('BlobStorageSettingsInlineProcessingThreshhold')]",
        "BlobStorageSettings__ConnectionString": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectoryStorageConnectionString)', parameters('keyVaultName'))]",
        "EnvironmentSettings__EnvironmentName": "[parameters('environmentName')]",
        "ApprenticeshipSettings__NationalRadius": "600",
        "ApprenticeshipSettings__SubRegionRadius": "10",
        "CourseServiceSettings__BulkUploadSecondsPerRecord": "[parameters('BulkUploadSecondsPerRecord')]",
        "DataProtection__ContainerName": "data-protection-keys",
        "ConnectionStrings__Redis": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectoryRedisConnectionString)', parameters('keyVaultName'))]",
        "BlobStorageBinaryStorageProviderSettings__ConnectionString": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectoryStorageConnectionString)', parameters('keyVaultName'))]",
        "BlobStorageBinaryStorageProviderSettings__ContainerName": "[parameters('blobStorageSettingsContainerName')]",
        "AzureSearchUrl": "[concat('https://', parameters('searchDomain'), '.search.windows.net')]",
        "AzureSearchQueryKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectorySearchQueryPrimaryKey)', parameters('keyVaultName'))]",
        "FindACourse__Url": "[parameters('FindACourseUrl')]",
        "Logging__ApplicationInsights__LogLevel__Default": "Information",
        "WEBSITE_RUN_FROM_PACKAGE": "1",
        "GoogleWebRiskSettings__ApiKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=GoogleWebRiskApiKey)', parameters('keyVaultName'))]"
      }
    },
    {
      "type": "Microsoft.Web/sites/slots/config",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}/{1}/{2}', variables('appServiceName'), 'staging' , 'connectionstrings')]",
      "properties": {
        "DefaultConnection": {
          "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectoryConnectionString)', parameters('keyVaultName'))]",
          "type": "SQLServer"
        }
      }
    },
    {
      "type": "Microsoft.Web/sites/slots/config",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}/{1}/{2}', variables('functionAppName'), 'staging', 'appsettings')]",
        "properties": {
            "FUNCTIONS_EXTENSION_VERSION": "~4",
            "FUNCTIONS_WORKER_RUNTIME": "dotnet-isolated",
            "MSDEPLOY_RENAME_LOCKED_FILES": "1",
            "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference(resourceId('microsoft.insights/components', variables('functionAppInsightsName')), '2015-05-01').InstrumentationKey]",
            "AzureWebJobsStorage": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectoryStorageConnectionString)', parameters('keyVaultName'))]",
            "BlobStorageSettings__ConnectionString": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectoryStorageConnectionString)', parameters('keyVaultName'))]",
            "AzureSearchUrl": "[concat('https://', parameters('searchDomain'), '.search.windows.net')]",
            "AzureSearchAdminKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectorySearchAdminPrimaryKey)', parameters('keyVaultName'))]",
            "LarsDataset__Url": "[parameters('larsDatasetUrl')]",
            "WEBSITE_RUN_FROM_PACKAGE": "1",
            "GoogleWebRiskSettings:ApiKey": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=GoogleWebRiskApiKey)', parameters('keyVaultName'))]",
            "CampaignDataContainerName": "campaign-data",
            "DataUploadsContainerName": "data-uploads",
            "CourseUploadsFolderName": "courses",
            "VenueUploadsFolderName": "venues",
            "ImportLarsDataTriggerTimer": "0 3 * * *",
            "ImportOnsDataTriggerTimer": "0 4 * * *"
        }
    },
    {
      "type": "Microsoft.Web/sites/slots/config",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}/{1}/{2}', variables('functionAppName'), 'staging', 'connectionstrings')]",
      "properties": {
        "DefaultConnection": {
          "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=CourseDirectorySqlConnectionString)', parameters('keyVaultName'))]",
          "type": "SQLServer"
        }
      }
    }
  ],
  "outputs": {
    "appInsightInstrumentationKey": {
      "type": "string",
      "value": "[reference(resourceId('microsoft.insights/components', variables('appInsightsName')), '2015-05-01').InstrumentationKey]"
    },
    "appServiceName": {
      "type": "string",
      "value": "[variables('appServiceName')]"
    }
  }
}
