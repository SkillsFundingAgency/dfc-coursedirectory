
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Http
@using Microsoft.AspNetCore.Identity
@using Dfc.CourseDirectory.Web.Areas.Identity.Data;
@using Dfc.CourseDirectory.Web.ViewComponents.ProviderSearch
@using Dfc.CourseDirectory.Models.Enums
@using Dfc.CourseDirectory.Web.ViewComponents.Notification
@using Dfc.CourseDirectory.Services.Interfaces.CourseService;

@inject IAuthorizationService Authorization
@inject IHttpContextAccessor HttpContextAccessor

@model Dfc.CourseDirectory.Web.ViewModels.DashboardViewModel;
@{
    Layout = "_Layout_Your_Courses";
}

@{
    var provSearch = HttpContextAccessor.HttpContext.Session.GetInt32("ProviderSearch");
    ViewData["Title"] = "Find a Provider";
    var isSignedIn = User.Identity.IsAuthenticated;
}
<div>


    @if (ViewBag.StatusMessage != null && isSignedIn == true)
    {
        <div class="failure-container">
            <h1 class="govuk-heading-m" style="font-size: 24px; font-weight: 700">@ViewBag.StatusMessage</h1>
        </div>
    }
<div id="VenueSearchResultContainer">
    @if (isSignedIn) //And is an ITSM OR Admin users
    {
        var authorised = await Authorization.AuthorizeAsync(User, "ElevatedUserRole");

        if (authorised.Succeeded)
        {
            <h1 class="govuk-heading-l">Find a course or training provider</h1>
            @await Component.InvokeAsync(nameof(ProviderSearch))

        }
        else
        {
            ViewData["Title"] = "Course management dashboard";


           var message = Model.LiveCourseCount > 0 ? " courses" : " course";
 

            @await Component.InvokeAsync(nameof(Notification), new NotificationModel
            {
                NotificationTitle = "",
                NotificationMessage = Model.LiveCourseCount.ToString() + message + " have been migrated to the new Course directory. Any courses with a missing LARS have been deleted." + "<a class='govuk-link' asp-controller='Home' asp-action='Index'> What now?</a>",
                ClassType = "info-summary"
            })

            <span class="govuk-caption-xl">Course Directory</span>



            if (!string.IsNullOrEmpty(Model.SuccessHeader))
            {
                @await Component.InvokeAsync(nameof(Notification), new NotificationModel
                {
                    NotificationTitle = Model.SuccessHeader,
                    ClassType = "success-summary"
                })
            }
            <h1 class="govuk-heading-xl">Course management dashboard</h1>
            if (Model.ValidationMessages != null)
            {
                if (Model.ValidationMessages.Count() > 0)
                {
                    <div class="cd-info-summary" aria-labelledby="info-summary-title" role="alert" tabindex="-1" data-module="info-summary">
                        <div class="cd-info-summary__body">
                            <div class="cd-info-summary__list">
                                @foreach (string msg in Model?.ValidationMessages)
                                {
                                    <a href="/DQI">@msg</a>

                                }
                                <br />
                                <a href="/PublishCourses/WhatDOYouWantToDoNext">(Stubbed) what next?</a>
                            </div>
                        </div>
                    </div>
                }
            }





            <div class="govuk-grid-row">
                <div class="govuk-grid-column-one-quarter">
                    <div class="cd-status-panel">
                        <h3 class="govuk-heading-l">@(Model?.LiveCourseCount ?? 0)</h3>
                        <div class="govuk-heading-s">Live courses</div>
                    </div>
                    <div>
                        <ul class="govuk-list">
                            <li><a class="govuk-link" asp-controller="RegulatedQualification" asp-action="Index">Publish a course</a></li>
                            @*<li><a class="govuk-link" asp-controller="Lars" asp-action="Index">Search for a course</a></li>*@
                            <li><a class="govuk-link" asp-controller="ProviderCourses" asp-action="Index">@((Model?.LiveCourseCount != null && Model?.LiveCourseCount > 0) ? "Manage your courses" : "")</a></li>
                        </ul>
                    </div>
                </div>
                @*
                    <div class="govuk-grid-column-one-quarter">
                        <div class="cd-status-panel">
                            <h3 class="govuk-heading-l">@(Model?.ArchivedCourseCount ?? 0)</h3>
                            <div class="govuk-heading-s">Archived courses</div>
                        </div>
                        <div>
                            <ul class="govuk-list">
                                <li><a class="govuk-link" href="#">Archive course</a></li>
                                <li><a class="govuk-link" href="#">Restore courses</a></li>
                            </ul>
                        </div>
                    </div>
                *@
                <div class="govuk-grid-column-one-quarter">
                    <div class="cd-status-panel">
                        <h3 class="govuk-heading-l">@(Model?.PendingCourseCount ?? 0)</h3>
                        <div class="govuk-heading-s">Pending courses</div>
                    </div>
                    <div>
                        <ul class="govuk-list">
                            @*<li><a class="govuk-link" href="#">Benefits calculators</a></li>*@
                            <li><a class="govuk-link" href="~/migration">Migrated courses</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            @*<h2 class="govuk-heading-l">Recent activity</h2>
                <div class="cd-activity-item">
                    <h3 class="govuk-heading-m cd-activity-item-heading ">Maths and applied physics</h3>
                    <span class="cd-activity-item-tag">Course ID</span> <span class="cd-activity-item-tag"> Venue</span> <span class="cd-activity-item-tag"> full-time</span> <span class="cd-activity-item-tag">25/03/2019</span>
                </div>
                <div class="cd-activity-item">
                    <h3 class="govuk-heading-m cd-activity-item-heading ">Maths and applied physics</h3>
                    <span class="cd-activity-item-tag">Course ID</span> <span class="cd-activity-item-tag"> Venue</span> <span class="cd-activity-item-tag"> full-time</span> <span class="cd-activity-item-tag">25/03/2019</span>
                </div>
                <div class="cd-activity-item">
                    <h3 class="govuk-heading-m cd-activity-item-heading ">Maths and applied physics</h3>
                    <span class="cd-activity-item-tag">Course ID</span> <span class="cd-activity-item-tag"> Venue</span> <span class="cd-activity-item-tag"> full-time</span> <span class="cd-activity-item-tag">25/03/2019</span>
                </div>*@

            @*</div>*@

        }
    }
    else
    {
        <h1 class="govuk-heading-l">Welcome to the Course Directory</h1>
        <h3 class="govuk-heading-m">This is the "private beta" of the new Course Directory developed by the National Careers Service.</h3>
        <br />
        <h3 class="govuk-heading-m">Please Login below: </h3>
        <div>

            <a class="govuk-link" asp-controller="Auth" asp-action="Login">Login</a>

        </div>
    }
</div>
</div>
