@using Dfc.CourseDirectory.Web.ViewComponents.Notification
@model UnRegulatedSearchViewModel

@{
    ViewData["Title"] = "Search for a course provision";
    Layout = "_Layout_Your_Courses";
}

@{
    var regex = @"^[zZ]{1}[a-zA-Z0-9]{7}$";
}

<div class="grid-row " data-sf-element="Row">
    <div class="column-two-thirds govuk-body">
        <div>
            <h1 class="govuk-heading-l govuk-!-margin-top-4">Find non-regulated award</h1>
        </div>
        <form id="zCodeSearch" asp-controller="UnregulatedCourses" asp-action="Index" method="post">
            <div id="errorsummary" class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="error-summary" style="display: none;">
                <h2 class="govuk-error-summary__title" id="error-summary-title">
                    There is a problem
                </h2>
                <div class="govuk-error-summary__body">
                    <ul class="govuk-list govuk-error-summary__list"></ul>
                </div>
            </div>

            <div class="govuk-body-l">
                A learning aims reference service (LARS) code is also known as a Z code. It always starts with a Z and is followed by a combination of 7 numbers or 7 numbers and letters.
            </div>

            <div class="govuk-form-group zcodesearch">
                <label name="unregulated-search">Enter a LARS code to search for the course</label>

                <div class="zcodesearch--container">
                    <input class=" zcodesearch--container-input govuk-input govuk-!-padding-bottom-4 govuk-input--width-10" asp-for="@Model.Search" type="text" aria-label="unregulated-search"
                           val-regex="@regex"
                           val-regex-message="Enter a valid LARS code" />

                    <button id="searchZCode" type="submit" class="submit">Search</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="grid-row" data-sf-element="Row">
    <div class="govuk-form-group ">
        <a class="govuk-link" id="unKnownLink" asp-controller="UnregulatedCourses" asp-action="UnknownZCode">I don’t know the LARS code</a>
        <br />
        <br />
        <div id="results">
        </div>
    </div>
</div>

<script>
    (function ($) {
        $(function () {
            var $code = $("#@nameof(Model.Search)").govUkInput();
            var $search = $("#searchZCode");
            var $errorSummary = $("#errorsummary").govUkErrorSummary();

            var doSearch = function () {
                $('#results').html("");
                makeRequestWithPayload({
                    Search: $('#Search').val()
                }, onSucess);
            };

            var onSucess = function (data) {
                $('#results').html("");
                $('#results').html(data);
            };

            var makeRequestWithPayload = function (payload, success) {
                var qs = $.param(payload);
                qs = replaceAll(qs, "%5B%5D", "");
                $.get("/UnregulatedCourses/FindNonRegulated?" + qs, success);
            };

            var replaceAll = function (search, find, replace) {
                return search.split(find).join(replace);
            };

            function validate() {
                $('.govuk-form-group--error .govuk-error-message').remove();

                if (!$.requiredValidate($code.val()) // Text box is empty.
                    || !$.regexValidate({ regex: $code.attr("val-regex") }, $code.val())) { // Format is incorrect.
                    const errorMessage = $code.attr("val-regex-message");
                    showError(errorMessage);
                    return false;
                } else {
                    $code.govUkInput("validState");
                    $errorSummary.govUkErrorSummary("hide");
                    return true;
                }
            }

            function showError(errorMessage) {
                var $anchor = document.createElement("a");
                $anchor.href = "#Search";
                $anchor.innerHTML = errorMessage;
                $anchor.id = "error-hash-link-" + "a" + "-" + 1;
                $errorSummary.govUkErrorSummary("add", $anchor);
                $errorSummary.govUkErrorSummary("show");

                $code.govUkInput("invalidState", errorMessage);
            }

            $(document).on('click', '#searchZCode', function (e) {
                e.preventDefault();
                $('#results').html("");
                const isValid = validate();
                if (isValid === true) {
                    doSearch();
                }
            });
        });
    })(jQuery);
</script>
