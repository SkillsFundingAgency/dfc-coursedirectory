@using Dfc.CourseDirectory.Models.Enums
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Identity
@using Dfc.CourseDirectory.Web.Areas.Identity.Data;
@using Dfc.CourseDirectory.Web.ViewComponents.Notification
@using Dfc.CourseDirectory.Web.ViewComponents.BackgroundBulkUploadNotification
@{
    ViewData["Title"] = "Bulk upload course information"; 
    Layout = "_Layout_Your_Courses";
}

@model Dfc.CourseDirectory.Web.ViewModels.BulkUpload.BulkUploadViewModel


@inject IAuthorizationService Authorization

@{
    var authorised = await Authorization.AuthorizeAsync(User, "Admin");
}

@if (Model.BulkUploadBackgroundInProgress)
{
    @await Component.InvokeAsync(nameof(BackgroundBulkUploadNotification),
        new BackgroundBulkUploadNotificationModel()
        {
            BulkUploadBackgroundInProgress = true,
            BulkUploadBackgroundRowCount = Model.BulkUploadBackgroundRowCount,
            BulkUploadBackgroundStartTimestamp = Model.BulkUploadBackgroundStartTimestamp
        } );
}


<h1 class="govuk-heading-l">Bulk upload course information</h1>

@{
    var styleAttribute = (string.IsNullOrEmpty(Model.NotificationTitle) && Model.errors == null)
        ? "style=\"display: none;\""
        : string.Empty;
}

<div id="errorSummary" class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="error-summary" @Html.Raw(styleAttribute)>
    <h2 class="govuk-error-summary__title" id="error-summary-title">
        @if (string.IsNullOrEmpty(Model.NotificationTitle))
        {
            <span>There is a problem</span>
        }
        else
        {
            @Model.NotificationTitle
        }
    </h2>
    <div class="govuk-error-summary__body">
        <ul class="govuk-list govuk-error-summary__list">
            @if (!string.IsNullOrEmpty(Model.NotificationMessage))
            {
                <li>@Model.NotificationMessage</li>
            }
            @if (Model.errors != null && Model.errors.Any())
            {
                foreach (var error in Model.errors)
                {
                    <li>
                        <span id="name-error" class="govuk-error-message">
                            <span class="govuk-visually-hidden">
                                Error:
                            </span>
                            @error
                        </span>
                    </li>
                }
            }
        </ul>
    </div>
</div>
<form method="post" id="bulkUploadForm" enctype="multipart/form-data"
      asp-controller="BulkUpload"
      asp-action="Index">
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <div class="govuk-body">
                <p>
 You can use a file to replace information about all of your published courses. To create the file you can:
                    <ul>
                        <li>enter your course information in an empty template</li>
                        <li>update a template containing your published course information</li>
                    </ul>
                </p>
                <p>
   Your updated course information will be published after you have uploaded your file and fixed any errors.
                </p>

                <div id="groupServerSideError" class="govuk-form-group">
                    <label class="govuk-heading-s" for="bulkUploadFile">
                        Upload a file
                    </label>
                    <span id="serverSideError" class="govuk-error-message" style="display: none">There is an error with the file. See above summary</span>
                    <input class="govuk-file-upload" id="bulkUploadFile" name="bulkUploadFile" type="file"
                           val-required-message="Select a file to upload"
                           val-file-extensions="csv"
                           val-file-extensions-message="The selected file must be a csv"
                           val-file-size-max="209715200"
                           val-file-size-max-message="The selected file must be smaller than 200MB" />
                </div>
                <div class="govuk-warning-text">
                    <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                    <strong class="govuk-warning-text__text">
                        <span class="govuk-warning-text__assistive">Warning</span>
   This will replace all of your course information in the course directory.
                    </strong>
                </div>
                <div class="govuk-form-group">
  <fieldset class="govuk-fieldset">
    <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
      <h1 class="govuk-fieldset__heading">
        Are you sure?
      </h1>
    </legend>
    <div class="govuk-radios">
      <div class="govuk-radios__item">
        <input class="govuk-radios__input" id="where-do-you-live" name="where-do-you-live" type="radio" value="Replace my existing course information">
        <label class="govuk-label govuk-radios__label" for="where-do-you-live">
                Replace my existing course information
        </label>
      </div>
      <div class="govuk-radios__item">
        <input class="govuk-radios__input" id="where-do-you-live-2" name="where-do-you-live" type="radio" value="Do not replace my existing course information and go back to my home page">
        <label class="govuk-label govuk-radios__label" for="where-do-you-live-2">
   Do not replace my existing course information and go back to my home page
        </label>
      </div>

    </div>
  </fieldset>
</div>

                <div class="cta-container">
                    <button type="submit" id="uploadButton" class="govuk-button govuk-!-margin-right-3">
                        Continue
                    </button>

                </div>
            </div>
        </div>
        <div class="govuk-grid-column-one-third">
            <div class="sidebar">

                <div class="widget white">
                    <h2 class="govuk-heading-m">Find templates</h2>

                    <ul class="govuk-list">
                        <li>
                            @Html.ActionLink("Download an empty file (CSV)", "GetBulkUploadTemplateFile", "BlobStorage")
                        </li>
                        <li class="govuk-!-padding-bottom-4">
                            @if (Model.HasMigrationErrors)
                            {
                                <p>Fix all migration errors in order to download a template containing your current courses</p>
                            }
                            else
                            {
                                @Html.ActionLink("Download a file containing your published courses (CSV)", "GetCurrentCoursesTemplateFile", "BlobStorage")
                            }

                        </li>
                    </ul>

                </div>
            </div>

        </div>
    </div>
</form>



<script>
        (function ($) {
            $(function () {
                var $errorSummary = $("#errorSummary").govUkErrorSummary();
                var $bulkUploadFile = $("#bulkUploadFile").govUkFileUpload();
                var $button = $("#uploadButton");

                var hasServerSideError = '@(Model.errors != null && Model.errors.Any() ? true : false)'
                if (hasServerSideError === 'True') {
                    $("#serverSideError").show();
                    $("#groupServerSideError").addClass("govuk-form-group--error");
                }
                else {
                    $("#serverSideError").hide();
                    $("#groupServerSideError").removeClass("govuk-form-group--error");
                }

                function goBack() {
  window.history.back();
}

                $bulkUploadFile.on("change", function () {
                    $bulkUploadFile.govUkFileUpload("validState");
                    $errorSummary.govUkErrorSummary("removeAll");
                    $errorSummary.govUkErrorSummary("hide");
                });

                $button.on("click", function (event) {
                    event.preventDefault();
                    if (!$.requiredValidate($bulkUploadFile.val())) {
                        $bulkUploadFile.govUkFileUpload("invalidState", $bulkUploadFile.attr("val-required-message"));
                        var errorHashLinks = $bulkUploadFile.govUkFileUpload("getErrorHashLinks");
                        $errorSummary.govUkErrorSummary("add", errorHashLinks);
                        $errorSummary.govUkErrorSummary("show");
                    } else if ($bulkUploadFile[0].files) {
                        if (!$.fileExtensionsValidate({ extensions: $bulkUploadFile.attr("val-file-extensions") }, $bulkUploadFile[0].files[0])) {
                            $bulkUploadFile.govUkFileUpload("invalidState", $bulkUploadFile.attr("val-file-extensions-message"));
                            var errorHashLinks = $bulkUploadFile.govUkFileUpload("getErrorHashLinks");
                            $errorSummary.govUkErrorSummary("add", errorHashLinks);
                            $errorSummary.govUkErrorSummary("show");
                        } else if (!$.fileSizeMaxValidate({ max: $bulkUploadFile.attr("val-file-size-max") }, $bulkUploadFile[0].files[0])) {
                            $bulkUploadFile.govUkFileUpload("invalidState", $bulkUploadFile.attr("val-file-size-max-message"));
                            var errorHashLinks = $bulkUploadFile.govUkFileUpload("getErrorHashLinks");
                            $errorSummary.govUkErrorSummary("add", errorHashLinks);
                            $errorSummary.govUkErrorSummary("show");
                        } else {
                            $bulkUploadFile.govUkFileUpload("validState");
                            $errorSummary.govUkErrorSummary("removeAll");
                            $errorSummary.govUkErrorSummary("hide");
                            $("#bulkUploadForm").submit();
                        }
                    } else {
                        $bulkUploadFile.govUkFileUpload("validState");
                        $errorSummary.govUkErrorSummary("removeAll");
                        $errorSummary.govUkErrorSummary("hide");
                        $("#bulkUploadForm").submit();
                    }
                });
            });
        })(jQuery);
</script>


