@using Dfc.CourseDirectory.Web.ViewComponents.PostcodeLookup;

@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@model Dfc.CourseDirectory.Web.ViewComponents.PostcodeLookup.PostcodeLookupModel

<div class="view-component-postcode-lookup">

    @if (Model.HasErrors)
    {
    <div class="govuk-form-group govuk-form-group--error">
        <label class="govuk-label govuk-!-font-weight-bold" for="Postcode">
            Postcode
        </label>
        <span asp-validation-for="Postcode" class="govuk-body">@string.Join(" ", Model.Errors)</span>
        <input asp-for="Postcode" 
            value="@Model.Postcode"
            class="govuk-input govuk-input--width-10 govuk-input--error">
    </div>
        <div class="govuk-form-group">
            <button type="button" class="govuk-button" id="PostcodeLookupFindAddress">
                Find address
            </button>
        </div>
    }
    else if (Model.Items.Any())
    {
        <div class="govuk-form-group">
            <label class="govuk-label govuk-!-font-weight-bold">
                Postcode
            </label>
            <span class="govuk-body govuk-!-font-weight-bold govuk-!-width-one-quarter">
                @Model.Postcode
            </span>
            <a class="govuk-body govuk-link" id="PostcodeLookupChange" href="#">Change</a>
        </div>
        <div class="govuk-form-group">
            <select class="govuk-select govuk-input--width-20">
                <option value="">Please select</option>
                @foreach (var item in Model.Items)
                {
                    <option value="@item.Id">@item.Text</option>
                }
            </select>
        </div>
    }
    else
    {
        <div class="govuk-form-group">
            <label class="govuk-label govuk-!-font-weight-bold" for="PostcodeLookupPostcode">
                Postcode
            </label>
            <span asp-validation-for="Postcode" class="govuk-body"></span>
            <input asp-for="Postcode"
                   value="@Model.Postcode"
                   class="govuk-input govuk-input--width-10 ">
        </div>
        <div class="govuk-form-group">
            <button type="button" class="govuk-button" id="PostcodeLookupFindAddress">
                Find address
            </button>
        </div>
    }

</div>
<script>
    "use strict";

    (function ($) {

        $(function () {

            var $postcodeLookupContainer = $(".view-component-postcode-lookup").parent();

            var $form = $postcodeLookupContainer.closest("form");

            $form.addTriggersToJqueryValidate().triggerElementValidationsOnFormValidation();

            var $postcode = $("#Postcode");
            var $change = $("#PostcodeLookupChange");
            var $findAddress = $("#PostcodeLookupFindAddress");

            $postcode.elementValidation(function (element, result) {
                var errorClass = 'error';
                var formGroup = $(element).closest('.govuk-form-group');

                if (formGroup) {
                    if (!formGroup.hasClass(errorClass) && result === false) {
                        formGroup.addClass(errorClass);
                    } else if (formGroup.hasClass(errorClass) && result === true) {
                        formGroup.removeClass(errorClass);
                    }
                }
            });

            var debounce = function (cb, delay) {
                var inDebounce;
                return function () {
                    var context = this;
                    var args = arguments;
                    clearTimeout(inDebounce);
                    inDebounce = setTimeout(function () {
                        cb.apply(context, args);
                    }, delay);
                };
            };

            var isNullOrWhitespace = function (input) {
                if (typeof input === 'undefined' || input == null) return true;
                return input.replace(/\s/g, '').length < 1;
            }

            var makeRequestWithPayload = function (payload, success) {
                console.log(payload);
                var qs = $.param(payload);
                $.get("/PostcodeLookup?" + qs, success);
            };

            var removeSearchResults = function () {
                $postcodeLookupContainer.html("");
            };

            var replaceSearchResult = function (searchResults) {
                $postcodeLookupContainer.html("");
                $postcodeLookupContainer.html(searchResults);
            };

            var doSearch = function () {
                if ($form.valid()) {
                    if (isNullOrWhitespace($postcode.val())) {
                        removeSearchResults();
                    } else {
                        makeRequestWithPayload({
                            Postcode: $postcode.val(),
                        }, onSucess);
                    }
                }
            };

            var goBack = function () {
                makeRequestWithPayload({
                    Postcode: "",
                }, onSucess);
            };

            var onSucess = function (data) {
                replaceSearchResult(data);
            };

            $findAddress.on("click", function (e) {
                e.preventDefault();
                doSearch();
            });

            $change.on("click", function (e) {
                e.preventDefault();
                goBack();
            });
        });

    } (jQuery));
</script>
